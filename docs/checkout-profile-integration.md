# Интеграция профиля с оформлением заказа

## Обзор

Данная функциональность позволяет:
1. **Создавать профиль** при оформлении заказа для неавторизованных пользователей
2. **Выбирать существующий профиль** при оформлении заказа
3. **Сохранять данные в профиль** для авторизованных пользователей
4. **Автозаполнение полей** из существующего профиля

## Архитектура

### Backend API

#### 1. Создание профиля из заказа
- **Endpoint**: `POST /api/trpc/profile.createProfileFromOrder`
- **Файл**: `packages/web-api/src/router/profile/create-profile-from-order.ts`
- **Функциональность**: Создает или обновляет профиль на основе данных заказа

#### 2. Поиск существующих профилей
- **Endpoint**: `GET /api/trpc/profile.findProfilesByEmail`
- **Файл**: `packages/web-api/src/router/profile/find-profiles-by-email.ts`
- **Функциональность**: Ищет профили по email для предложения существующих вариантов

#### 3. Обновление создания заказа
- **Файл**: `packages/web-api/src/lib/orders/order-helpers.ts`
- **Изменения**: Добавлена поддержка создания профиля при оформлении заказа

### Frontend компоненты

#### 1. Селектор существующих профилей
- **Файл**: `apps/web/src/features/checkout/components/existing-profiles-selector.tsx`
- **Функциональность**: Показывает список существующих профилей для выбора

#### 2. Обновленный чекбокс сохранения
- **Файл**: `apps/web/src/features/checkout/components/save-to-profile-checkbox.tsx`
- **Функциональность**: Предлагает создание профиля для неавторизованных пользователей

#### 3. Хук для работы с профилями
- **Файл**: `apps/web/src/features/checkout/hooks/use-existing-profiles.ts`
- **Функциональность**: Управляет запросами к API для поиска профилей

## Схемы валидации

### Обновленные схемы
- `packages/web-validators/src/orders.ts` - добавлены поля `saveToProfile` и `createProfile`
- `packages/web-validators/src/checkout.ts` - добавлено поле `saveToProfile`

## Пользовательский опыт

### Для неавторизованных пользователей

1. **Ввод email** - система автоматически ищет существующие профили
2. **Выбор профиля** - если найдены профили, пользователь может выбрать один из них
3. **Создание нового профиля** - опция создания профиля на основе данных заказа
4. **Автозаполнение** - при выборе профиля все поля заполняются автоматически

### Для авторизованных пользователей

1. **Использование данных профиля** - автоматическое заполнение из существующего профиля
2. **Сохранение изменений** - возможность сохранить измененные данные в профиль
3. **Выбор адресов** - использование сохраненных адресов доставки

## База данных

### Изменения в схеме
- Поле `isGuest` в таблице `customers` - определяет статус пользователя
- Поле `isDefault` в таблице `customerAddresses` - основной адрес пользователя
- Поле `metadata` в таблице `orders` - сохраняет информацию о создании профиля

## Тестирование

### Unit тесты
- `packages/web-api/test/profile/create-profile-from-order.test.ts` - тесты API создания профиля

### Тестовые сценарии
1. Создание нового профиля при заказе
2. Обновление существующего профиля
3. Создание профиля без сохранения адреса
4. Поиск существующих профилей по email

## Безопасность

### Валидация данных
- Все входные данные валидируются через Zod схемы
- Email проверяется на корректность
- Обязательные поля проверяются на заполненность

### Обработка ошибок
- Graceful handling ошибок при создании профиля
- Не прерывает создание заказа при ошибках профиля
- Логирование ошибок для отладки

## Производительность

### Оптимизации
- Кэширование запросов профилей (5 минут)
- Ленивая загрузка профилей только при вводе email
- Транзакции для атомарности операций

### Мониторинг
- Логирование операций создания профиля
- Метрики успешности создания профилей
- Отслеживание использования существующих профилей

## Развертывание

### Миграции
- Нет изменений в схеме БД (используются существующие поля)
- Обратная совместимость с существующими заказами

### Конфигурация
- Функциональность включена по умолчанию
- Возможность отключения через feature flags

## Будущие улучшения

### Планируемые функции
1. **Верификация email** при создании профиля
2. **Интеграция с системой лояльности**
3. **Персонализированные предложения**
4. **История заказов в профиле**
5. **Множественные адреса доставки**

### Технические улучшения
1. **Кэширование профилей** на уровне приложения
2. **Асинхронная обработка** создания профилей
3. **Интеграция с аналитикой** для отслеживания конверсии 