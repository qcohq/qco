# Автосохранение черновиков оформления заказа

## Обзор

Функция автосохранения черновиков оформления заказа позволяет пользователям сохранять введенные данные формы в реальном времени. Это предотвращает потерю данных при случайном закрытии страницы или переходе на другие страницы сайта.

## Архитектура

### Компоненты

1. **Таблица в базе данных** (`checkout_drafts`)
   - Хранит черновики оформления заказа
   - Связана с таблицей `customers` через `customer_id`
   - Для гостей использует `session_id`

2. **tRPC процедуры**
   - `getDraft` - получение черновика
   - `saveDraft` - сохранение черновика

3. **React хук** (`useCheckoutDraft`)
   - Управляет логикой автосохранения
   - Использует debounce для оптимизации запросов
   - Загружает данные черновика при монтировании компонента

4. **Компонент страницы оформления заказа**
   - Интегрирует хук автосохранения
   - Отображает состояние загрузки черновика

## Реализация

### База данных

Таблица `checkout_drafts` содержит следующие поля:

- `id` - уникальный идентификатор
- `customer_id` - ссылка на клиента (для авторизованных пользователей)
- `session_id` - идентификатор сессии (для гостей)
- `draft_data` - JSON данные формы
- `created_at` - дата создания
- `updated_at` - дата обновления

### tRPC процедуры

#### getDraft

Получает последний черновик оформления заказа для пользователя.

**Параметры:**
- `customerId` (опционально) - идентификатор клиента
- `sessionId` (опционально) - идентификатор сессии

**Возвращает:**
- `id` - идентификатор черновика
- `draftData` - данные формы
- `createdAt` - дата создания
- `updatedAt` - дата обновления

#### saveDraft

Сохраняет черновик оформления заказа.

**Параметры:**
- `customerId` (опционально) - идентификатор клиента
- `sessionId` (опционально) - идентификатор сессии
- `draftData` - данные формы для сохранения

**Возвращает:**
- `id` - идентификатор черновика
- `draftData` - сохраненные данные формы
- `createdAt` - дата создания
- `updatedAt` - дата обновления

### React хук

Хук `useCheckoutDraft` предоставляет следующую функциональность:

- Загрузку черновика при монтировании компонента
- Автосохранение данных формы с debounce (1 секунда)
- Обработку состояний загрузки и ошибок

### Интеграция в компонент

Компонент страницы оформления заказа использует хук следующим образом:

```tsx
const form = useForm<CheckoutFormValues>({
  // конфигурация формы
});

const { isDraftLoading } = useCheckoutDraft(form);

// Подписка на изменения формы
useEffect(() => {
  const subscription = form.watch((data) => {
    autoSave(data as CheckoutFormValues);
  });

  return () => subscription.unsubscribe();
}, [form, autoSave]);
```

## Использование

1. При открытии страницы оформления заказа:
   - Загружается последний черновик (если есть)
   - Данные формы заполняются из черновика

2. При заполнении формы:
   - Данные автоматически сохраняются с задержкой в 1 секунду
   - Предыдущий таймер отменяется при каждом новом изменении

3. При отправке формы:
   - Черновик может быть удален (опционально)

## Безопасность

- Данные черновиков хранятся отдельно от завершенных заказов
- Для гостей используется идентификатор сессии
- Для авторизованных пользователей используется идентификатор клиента
- Все данные валидируются перед сохранением

## Тестирование

Функциональность покрыта unit-тестами:

- Инициализация хука
- Автосохранение данных формы
- Обработка ошибок
- Загрузка черновика

## Оптимизация

- Использование debounce для уменьшения количества запросов
- Индексация таблицы по customer_id и session_id
- Кэширование запросов через React Query

## Возможные улучшения

- Добавить индикатор состояния автосохранения (сохраняется/сохранено)
- Реализовать локальное хранилище как fallback при недоступности сервера
- Добавить возможность просмотра и управления черновиками в личном кабинете
